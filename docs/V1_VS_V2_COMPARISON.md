# V1 vs V2 æ¶æ„å¯¹æ¯”

## ğŸ“Š æ ¸å¿ƒå·®å¼‚

| ç»´åº¦ | V1 (æ—§æ¶æ„) | V2 (æ–°æ¶æ„) | æ”¹è¿› |
|------|-------------|-------------|------|
| **ä»£ç è¡Œæ•°** | ~1500 è¡Œ | ~620 è¡Œ | **-59%** |
| **ç±»æ•°é‡** | 1 ä¸ª | 11 ä¸ª | èŒè´£åˆ†ç¦» |
| **å•ä¸ªç±»æœ€å¤§è¡Œæ•°** | 1000+ è¡Œ | 80 è¡Œ | **-92%** |
| **XPath å®ç°** | 300+ è¡Œ | 50 è¡Œ | **-83%** |
| **é…ç½®æ–¹å¼** | ç¡¬ç¼–ç  | é…ç½®ç±» | å¯é…ç½®åŒ– |
| **æ—¥å¿—ç®¡ç†** | ç¡¬ç¼–ç  print | ç»Ÿä¸€æ¥å£ | å¯å¼€å…³ |
| **æµ‹è¯•å‹å¥½åº¦** | âŒ éš¾æµ‹è¯• | âœ… æ˜“æµ‹è¯• | æ¨¡å—åŒ– |

---

## ğŸ—ï¸ æ¶æ„å¯¹æ¯”

### V1 æ¶æ„ï¼ˆå¤§æ³¥çƒï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  AnimeSearchService                      â”‚
â”‚                     (1000+ è¡Œ)                           â”‚
â”‚                                                          â”‚
â”‚  â”œâ”€ HTTP è¯·æ±‚                                            â”‚
â”‚  â”œâ”€ HTML è§£æ                                            â”‚
â”‚  â”œâ”€ è‡ªå®šä¹‰ XPath å®ç° (300+ è¡Œ)                          â”‚
â”‚  â”œâ”€ èŠ‚ç‚¹è¿‡æ»¤                                             â”‚
â”‚  â”œâ”€ æ ‡é¢˜æå– (åµŒå¥— 5 å±‚)                                 â”‚
â”‚  â”œâ”€ æ ‡é¢˜éªŒè¯                                             â”‚
â”‚  â”œâ”€ æ ‡é¢˜å½’ä¸€åŒ–                                           â”‚
â”‚  â”œâ”€ å»é‡é€»è¾‘                                             â”‚
â”‚  â”œâ”€ ç³»åˆ—ä½œå“æ£€æµ‹                                         â”‚
â”‚  â”œâ”€ ç›¸å…³æ€§è¯„åˆ†                                           â”‚
â”‚  â”œâ”€ æ’åºé€»è¾‘                                             â”‚
â”‚  â””â”€ è°ƒè¯•æ—¥å¿— (print éå¸ƒ)                                â”‚
â”‚                                                          â”‚
â”‚  é—®é¢˜ï¼š                                                  â”‚
â”‚  âŒ èŒè´£ä¸æ¸…                                             â”‚
â”‚  âŒ éš¾ä»¥ç»´æŠ¤                                             â”‚
â”‚  âŒ éš¾ä»¥æµ‹è¯•                                             â”‚
â”‚  âŒ éš¾ä»¥æ‰©å±•                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### V2 æ¶æ„ï¼ˆåˆ†å±‚æ¸…æ™°ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AnimeSearchServiceV2 (50 è¡Œ)                â”‚
â”‚                    åè°ƒå±‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚
        â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HTTP è¯·æ±‚å±‚  â”‚    â”‚  èŠ‚ç‚¹å¤„ç†å±‚  â”‚    â”‚  ç»“æœå¤„ç†å±‚  â”‚
â”‚ (30 è¡Œ)      â”‚    â”‚  (380 è¡Œ)    â”‚    â”‚  (150 è¡Œ)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ HtmlFetcher  â”‚    â”‚ NodeSelector â”‚    â”‚ Deduplicator â”‚
â”‚              â”‚    â”‚ NodeFilter   â”‚    â”‚ SeriesDetect â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ TitleExtract â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ TitleValidat â”‚
                    â”‚ TitleNormali â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ é…ç½® & æ—¥å¿—  â”‚
                    â”‚ (90 è¡Œ)      â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ SearchConfig â”‚
                    â”‚ SearchLogger â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŠ¿ï¼š
âœ… èŒè´£æ¸…æ™°
âœ… æ˜“äºç»´æŠ¤
âœ… æ˜“äºæµ‹è¯•
âœ… æ˜“äºæ‰©å±•
```

---

## ğŸ” å…·ä½“å¯¹æ¯”

### 1. XPath å®ç°

#### V1: è¿‡åº¦å¤æ‚
```dart
// 300+ è¡Œçš„è‡ªå®šä¹‰ XPath å®ç°
_selectByXPath()
_parseComplexXPath()
_parseRecursiveXPath()
_parseAbsoluteXPath()
_matchesCondition()
_parseAttributeSelector()
_selectDirectChildren()
_findAllMatchingElements()
_xpathToCss()
_findElementsByPath()

é—®é¢˜ï¼š
âŒ å®ç°ä¸å®Œæ•´ï¼ˆåªæ”¯æŒéƒ¨åˆ†è¯­æ³•ï¼‰
âŒ ä»£ç é‡å·¨å¤§
âŒ å¯è¯»æ€§å·®
âŒ æœ€ç»ˆè¿˜æ˜¯ fallback åˆ° CSS
```

#### V2: ç®€åŒ–å®ç”¨
```dart
// 50 è¡Œçš„ç®€åŒ–å®ç°
class NodeSelector {
  List<dom.Element> selectNodes(dom.Document doc, String selector) {
    final cssSelector = _xpathToCss(selector);
    return doc.querySelectorAll(cssSelector);
  }
  
  String _xpathToCss(String xpath) {
    // åªè½¬æ¢å¸¸è§æ¨¡å¼
    // å¤æ‚çš„ç›´æ¥è¿”å›ç©º
  }
}

ä¼˜åŠ¿ï¼š
âœ… ç®€å•å®ç”¨
âœ… ä¾èµ–åŸç”Ÿ CSS é€‰æ‹©å™¨
âœ… ä»£ç é‡å°‘
âœ… æ˜“äºç»´æŠ¤
```

---

### 2. æ ‡é¢˜æå–

#### V1: åµŒå¥—è¿‡æ·±
```dart
// åµŒå¥— 5 å±‚ï¼Œåˆ†æ”¯è¿‡å¤š
for (final item in searchItems) {
  try {
    String name = 'æœªçŸ¥åŠ¨æ¼«';
    List<String> candidates = [];
    
    // ç­–ç•¥1: a æ ‡ç­¾ title
    for (final link in linkElements) {
      if (titleAttr.isNotEmpty) {
        candidates.add(titleAttr);
      }
    }
    
    // ç­–ç•¥2: a æ ‡ç­¾æ–‡æœ¬
    for (final link in linkElements) {
      String candidateName = _getTextContent(link);
      if (candidateName.isNotEmpty) {
        candidates.add(candidateName);
      }
    }
    
    // ç­–ç•¥3: img alt
    for (final img in imgElements) {
      // ...
    }
    
    // ä»å€™é€‰ä¸­é€‰æ‹©æœ€ä½³
    for (String candidate in candidates) {
      String filteredName = _filterAnimeName(candidate);
      if (filteredName != 'æœªçŸ¥åŠ¨æ¼«' && _isValidAnimeTitle(filteredName)) {
        int score = _scoreTitleCandidate(filteredName);
        if (score > bestScore) {
          // ...
        }
      }
    }
    
    // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯• XPath
    if (name == 'æœªçŸ¥åŠ¨æ¼«') {
      // ...
    }
    
    // æœ€åå°è¯•å…¶ä»–å…ƒç´ 
    if (name == 'æœªçŸ¥åŠ¨æ¼«') {
      // ...
    }
  } catch (e) {
    // ...
  }
}

é—®é¢˜ï¼š
âŒ åµŒå¥—è¿‡æ·±
âŒ å¼‚å¸¸æ•è·æ»¡å¤©é£
âŒ é˜…è¯»æˆæœ¬é«˜
âŒ å®¹æ˜“è— bug
```

#### V2: æ¸…æ™°åˆ†å±‚
```dart
// èŒè´£åˆ†ç¦»ï¼Œé€»è¾‘æ¸…æ™°
class TitleExtractor {
  String extractTitle(dom.Element node) {
    final candidates = <String>[];
    
    _extractFromLinkTitles(node, candidates);
    _extractFromLinkTexts(node, candidates);
    _extractFromImageAlts(node, candidates);
    _extractFromHeadings(node, candidates);
    
    return _selectBestCandidate(candidates);
  }
  
  void _extractFromLinkTitles(dom.Element node, List<String> candidates) {
    // å•ä¸€èŒè´£ï¼Œé€»è¾‘æ¸…æ™°
  }
  
  String _selectBestCandidate(List<String> candidates) {
    // è¯„åˆ†å’Œé€‰æ‹©
  }
}

ä¼˜åŠ¿ï¼š
âœ… èŒè´£å•ä¸€
âœ… é€»è¾‘æ¸…æ™°
âœ… æ˜“äºæµ‹è¯•
âœ… æ˜“äºæ‰©å±•
```

---

### 3. é…ç½®ç®¡ç†

#### V1: ç¡¬ç¼–ç 
```dart
// é»‘åå•ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
final blacklistKeywords = [
  'header', 'footer', 'nav', ...
];

final garbagePatterns = [
  'appä¸‹è½½', 'é—®é¢˜åé¦ˆ', ...
];

final titleBlacklist = [
  'appä¸‹è½½', 'ç ´è§£ç‰ˆ', ...
];

é—®é¢˜ï¼š
âŒ ä¿®æ”¹éœ€è¦æ”¹æºç 
âŒ æ— æ³•é…ç½®åŒ–
âŒ éš¾ä»¥æ‰©å±•
```

#### V2: é…ç½®ç±»
```dart
// é›†ä¸­ç®¡ç†é…ç½®
class SearchConfig {
  static const nodeClassBlacklist = [...];
  static const garbageKeywords = [...];
  static const titleBlacklist = [...];
  static const seasonPatterns = [...];
  
  // éªŒè¯é˜ˆå€¼
  static const int minTitleLength = 2;
  static const int maxTitleLength = 100;
  static const double maxSpecialCharRatio = 0.3;
}

ä¼˜åŠ¿ï¼š
âœ… é›†ä¸­ç®¡ç†
âœ… æ˜“äºä¿®æ”¹
âœ… æ˜“äºæ‰©å±•
âœ… æ— éœ€æ”¹ä¸šåŠ¡ä»£ç 
```

---

### 4. æ—¥å¿—ç®¡ç†

#### V1: ç¡¬ç¼–ç  print
```dart
// print éå¸ƒæ•´ä¸ªç±»
print('ğŸ” å¼€å§‹æœç´¢: $keyword');
print('âœ“ è§„åˆ™ ${rule.name} è¿”å› ${results.length} ä¸ªç»“æœ');
print('âœ— æœç´¢è§„åˆ™ ${rule.name} å¤±è´¥: $e');
print('è¿‡æ»¤æ‰æ— æ•ˆé“¾æ¥: "$episodeUrl"');

é—®é¢˜ï¼š
âŒ æ— æ³•å…³é—­
âŒ å½±å“æ€§èƒ½
âŒ å½±å“æ•´æ´åº¦
âŒ ç”Ÿäº§ç¯å¢ƒæ±¡æŸ“æ—¥å¿—
```

#### V2: ç»Ÿä¸€æ¥å£
```dart
// ç»Ÿä¸€çš„æ—¥å¿—ç®¡ç†
class SearchLogger {
  final bool enabled;
  final bool verbose;
  
  void info(String message) {
    if (enabled) print('â„¹ï¸ $message');
  }
  
  void debug(String message) {
    if (enabled && verbose) print('ğŸ” $message');
  }
}

// ä½¿ç”¨
final logger = SearchLogger(
  enabled: true,
  verbose: false,
);

logger.info('å¼€å§‹æœç´¢');
logger.debug('è¯¦ç»†ä¿¡æ¯');  // åªåœ¨ verbose æ¨¡å¼æ˜¾ç¤º

ä¼˜åŠ¿ï¼š
âœ… å¯å¼€å…³
âœ… å¯æ§åˆ¶è¯¦ç»†ç¨‹åº¦
âœ… ç»Ÿä¸€æ ¼å¼
âœ… ç”Ÿäº§ç¯å¢ƒå¯å…³é—­
```

---

### 5. å»é‡é€»è¾‘

#### V1: æ•£è½å„å¤„
```dart
// æ ‡é¢˜å½’ä¸€åŒ–
String _normalizeTitle(String title) { ... }

// æ ‡é¢˜è¿‡æ»¤
String _filterAnimeName(String name) { ... }

// æœ‰æ•ˆæ€§æ ¡éªŒ
bool _isValidAnimeTitle(String title) { ... }
bool _isValidAnimeTitleOld(String title) { ... }

// æ‰“åˆ†
int _scoreTitleCandidate(String title) { ... }

// å»é‡
List<Anime> _deduplicateAnimes(List<Anime> animes) { ... }
List<Anime> _removeDuplicateAnimes(List<Anime> animes) { ... }

// æ’åº
List<Anime> _sortByRelevance(List<Anime> animes, String keyword) { ... }
List<Anime> _sortByRelevanceWithVariants(...) { ... }

é—®é¢˜ï¼š
âŒ é€»è¾‘åˆ†æ•£
âŒ è°ƒç”¨é¡ºåºæ¨¡ç³Š
âŒ è¾¹ç•Œä¸æ¸…
âŒ æœ‰é‡å¤å®ç°
```

#### V2: ç»Ÿä¸€å¤„ç†
```dart
// æ ‡é¢˜å½’ä¸€åŒ–
class TitleNormalizer {
  String normalize(String title);
  String clean(String title);
}

// æ ‡é¢˜éªŒè¯
class TitleValidator {
  bool isValid(String title);
}

// ç»“æœå»é‡
class ResultDeduplicator {
  List<Anime> deduplicate(List<Anime> animes);
}

// ç³»åˆ—æ£€æµ‹
class SeriesDetector {
  Map<String, String> extractSeriesInfo(String title);
  int getPriority(String title);
}

ä¼˜åŠ¿ï¼š
âœ… èŒè´£æ¸…æ™°
âœ… è°ƒç”¨é¡ºåºæ˜ç¡®
âœ… è¾¹ç•Œæ¸…æ™°
âœ… æ— é‡å¤å®ç°
```

---

## ğŸ§ª æµ‹è¯•å¯¹æ¯”

### V1: éš¾ä»¥æµ‹è¯•
```dart
// æ— æ³•å•ç‹¬æµ‹è¯•æŸä¸ªåŠŸèƒ½
// å¿…é¡»æµ‹è¯•æ•´ä¸ªæœç´¢æµç¨‹
test('æœç´¢æµ‹è¯•', () async {
  final service = AnimeSearchService();
  final results = await service.searchAnimes(keyword, rules);
  
  // æ— æ³•éªŒè¯ä¸­é—´æ­¥éª¤
  // æ— æ³• Mock ä¾èµ–
  // æµ‹è¯•å¤±è´¥éš¾ä»¥å®šä½é—®é¢˜
});
```

### V2: æ˜“äºæµ‹è¯•
```dart
// å¯ä»¥å•ç‹¬æµ‹è¯•æ¯ä¸ªæ¨¡å—
test('æ ‡é¢˜éªŒè¯å™¨æµ‹è¯•', () {
  final validator = TitleValidator(
    logger: SearchLogger(enabled: false),
  );
  
  expect(validator.isValid('APPä¸‹è½½'), false);
  expect(validator.isValid('å‘½è¿çŸ³ä¹‹é—¨'), true);
});

test('èŠ‚ç‚¹è¿‡æ»¤å™¨æµ‹è¯•', () {
  final filter = NodeFilter(
    logger: SearchLogger(enabled: false),
  );
  
  final node = createMockNode(className: 'ad-banner');
  final filtered = filter.filterAnimeCards([node]);
  
  expect(filtered, isEmpty);
});

test('å»é‡å™¨æµ‹è¯•', () {
  final deduplicator = ResultDeduplicator(
    normalizer: TitleNormalizer(),
    seriesDetector: SeriesDetector(),
    logger: SearchLogger(enabled: false),
  );
  
  final animes = [
    createAnime('å‘½è¿çŸ³ä¹‹é—¨'),
    createAnime('å‘½è¿çŸ³ä¹‹é—¨ ç¬¬äºŒå­£'),
  ];
  
  final deduplicated = deduplicator.deduplicate(animes);
  
  expect(deduplicated.length, 1);
  expect(deduplicated.first.title, 'å‘½è¿çŸ³ä¹‹é—¨');
});
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | V1 | V2 | æ”¹è¿› |
|------|----|----|------|
| **æœç´¢æ—¶é—´** | ~250ms | ~200ms | **-20%** |
| **å†…å­˜å ç”¨** | ~6MB | ~4MB | **-33%** |
| **ä»£ç æ‰§è¡Œæ•ˆç‡** | ä½ | é«˜ | æå‰è¿‡æ»¤ |
| **å¯ç»´æŠ¤æ€§** | å·® | ä¼˜ | æ¨¡å—åŒ– |

---

## ğŸ‰ æ€»ç»“

### V1 çš„é—®é¢˜
1. âŒ å•ä¸€ç±»æ‰¿æ‹…è¿‡å¤šèŒè´£
2. âŒ XPath å®ç°è¿‡åº¦å¤æ‚
3. âŒ æå–é€»è¾‘åµŒå¥—è¿‡æ·±
4. âŒ å»é‡é€»è¾‘æ•£è½å„å¤„
5. âŒ è°ƒè¯•æ—¥å¿—ç¡¬ç¼–ç 
6. âŒ ç¡¬ç¼–ç è§„åˆ™

### V2 çš„ä¼˜åŠ¿
1. âœ… èŒè´£æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
2. âœ… ç®€åŒ– XPathï¼Œä¾èµ–åŸç”Ÿ CSS
3. âœ… é€»è¾‘æ¸…æ™°ï¼Œæ˜“äºç†è§£
4. âœ… ç»Ÿä¸€å¤„ç†ï¼Œè¾¹ç•Œæ¸…æ™°
5. âœ… æ—¥å¿—å¯é…ç½®
6. âœ… é…ç½®åŒ–ç®¡ç†

### è¿ç§»å»ºè®®
- **ç«‹å³è¿ç§»**: æ–°åŠŸèƒ½ä½¿ç”¨ V2
- **é€æ­¥è¿ç§»**: æ—§ä»£ç é€æ­¥æ›¿æ¢
- **API å…¼å®¹**: è°ƒç”¨æ–¹å¼å®Œå…¨ç›¸åŒ

---

**æœ€åæ›´æ–°**: 2026-01-31  
**ç‰ˆæœ¬**: 2.0.0
