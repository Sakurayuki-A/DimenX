# æœç´¢æœåŠ¡é‡æ„ - æ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ¯ é‡æ„ç›®æ ‡

è§£å†³åŸæœ‰ `AnimeSearchService` çš„æ ¸å¿ƒé—®é¢˜ï¼š
1. âŒ å•ä¸€ç±»æ‰¿æ‹…è¿‡å¤šèŒè´£ï¼ˆ1000+ è¡Œï¼‰
2. âŒ è‡ªå®šä¹‰ XPath å®ç°è¿‡åº¦å¤æ‚
3. âŒ æå–é€»è¾‘åµŒå¥—è¿‡æ·±
4. âŒ å»é‡ã€æ’åºé€»è¾‘æ•£è½å„å¤„
5. âŒ è°ƒè¯•æ—¥å¿—ç¡¬ç¼–ç åœ¨ä¸šåŠ¡é€»è¾‘ä¸­
6. âŒ ç¡¬ç¼–ç è§„åˆ™ä¸é­”æ³•å­—ç¬¦ä¸²

---

## ğŸ—ï¸ æ–°æ¶æ„è®¾è®¡

### åˆ†å±‚æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  AnimeSearchServiceV2                    â”‚
â”‚                    (åè°ƒå±‚ - 50è¡Œ)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚
        â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HTTP è¯·æ±‚å±‚  â”‚    â”‚  èŠ‚ç‚¹å¤„ç†å±‚  â”‚    â”‚  ç»“æœå¤„ç†å±‚  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ HtmlFetcher  â”‚    â”‚ NodeSelector â”‚    â”‚ Deduplicator â”‚
â”‚              â”‚    â”‚ NodeFilter   â”‚    â”‚ SeriesDetect â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ TitleExtract â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ TitleValidat â”‚
                    â”‚ TitleNormali â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  é…ç½® & æ—¥å¿—  â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ SearchConfig â”‚
                    â”‚ SearchLogger â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ æ¨¡å—èŒè´£åˆ’åˆ†

### 1. HTTP è¯·æ±‚å±‚

#### `HtmlFetcher` (30è¡Œ)
**å•ä¸€èŒè´£**: HTTP è¯·æ±‚å’Œ HTML è§£æ

```dart
class HtmlFetcher {
  Future<dom.Document> fetchSearchPage(String keyword, SourceRule rule);
}
```

**èŒè´£**:
- âœ… æ„å»ºæœç´¢ URL
- âœ… å‘é€ HTTP è¯·æ±‚
- âœ… è§£æ HTML æ–‡æ¡£
- âœ… å¼‚å¸¸å¤„ç†

---

### 2. èŠ‚ç‚¹å¤„ç†å±‚

#### `NodeSelector` (50è¡Œ)
**å•ä¸€èŒè´£**: CSS é€‰æ‹©å™¨ï¼ˆæ”¾å¼ƒå¤æ‚ XPathï¼‰

```dart
class NodeSelector {
  List<dom.Element> selectNodes(dom.Document document, String selector);
}
```

**èŒè´£**:
- âœ… ç®€å• XPath åˆ° CSS è½¬æ¢
- âœ… èŠ‚ç‚¹é€‰æ‹©
- âŒ ä¸å†å®ç°å®Œæ•´ XPathï¼ˆè¿‡åº¦å¤æ‚ï¼‰

**ç®€åŒ–ç­–ç•¥**:
- åªæ”¯æŒå¸¸è§ XPath æ¨¡å¼
- å¤æ‚é€‰æ‹©å™¨ç›´æ¥è¿”å›ç©º
- ä¾èµ– CSS é€‰æ‹©å™¨ï¼ˆDart html åŒ…åŸç”Ÿæ”¯æŒï¼‰

---

#### `NodeFilter` (80è¡Œ)
**å•ä¸€èŒè´£**: è¿‡æ»¤æ— æ•ˆèŠ‚ç‚¹

```dart
class NodeFilter {
  List<dom.Element> filterAnimeCards(List<dom.Element> nodes);
}
```

**èŒè´£**:
- âœ… ç»“æ„éªŒè¯ï¼ˆé“¾æ¥ã€å›¾ç‰‡ã€æ ‡é¢˜ï¼‰
- âœ… é»‘åå•è¿‡æ»¤
- âœ… åƒåœ¾å†…å®¹æ£€æµ‹
- âœ… æ–‡æœ¬é•¿åº¦éªŒè¯

---

#### `TitleExtractor` (80è¡Œ)
**å•ä¸€èŒè´£**: ä»èŠ‚ç‚¹æå–æ ‡é¢˜

```dart
class TitleExtractor {
  String extractTitle(dom.Element node);
}
```

**èŒè´£**:
- âœ… å¤šç­–ç•¥æå–ï¼ˆaæ ‡ç­¾ã€imgã€æ ‡é¢˜å…ƒç´ ï¼‰
- âœ… å€™é€‰æ ‡é¢˜è¯„åˆ†
- âœ… é€‰æ‹©æœ€ä½³æ ‡é¢˜

---

#### `TitleValidator` (60è¡Œ)
**å•ä¸€èŒè´£**: éªŒè¯æ ‡é¢˜æœ‰æ•ˆæ€§

```dart
class TitleValidator {
  bool isValid(String title);
}
```

**èŒè´£**:
- âœ… é•¿åº¦éªŒè¯
- âœ… å­—ç¬¦ç±»å‹éªŒè¯
- âœ… é»‘åå•éªŒè¯
- âœ… ç‰¹æ®Šå­—ç¬¦æ£€æµ‹

---

#### `TitleNormalizer` (30è¡Œ)
**å•ä¸€èŒè´£**: æ ‡é¢˜æ¸…æ´—å’Œå½’ä¸€åŒ–

```dart
class TitleNormalizer {
  String normalize(String title);  // ç”¨äºå»é‡
  String clean(String title);      // ç§»é™¤æ— å…³ä¿¡æ¯
}
```

**èŒè´£**:
- âœ… æ ‡é¢˜å½’ä¸€åŒ–ï¼ˆå»é‡ç”¨ï¼‰
- âœ… æ ‡é¢˜æ¸…æ´—ï¼ˆç§»é™¤æ‹¬å·ã€é›†æ•°ç­‰ï¼‰

---

### 3. ç»“æœå¤„ç†å±‚

#### `ResultDeduplicator` (70è¡Œ)
**å•ä¸€èŒè´£**: å»é‡å’Œåˆå¹¶ç³»åˆ—ä½œå“

```dart
class ResultDeduplicator {
  List<Anime> deduplicate(List<Anime> animes);
}
```

**èŒè´£**:
- âœ… æ ‡é¢˜å½’ä¸€åŒ–å»é‡
- âœ… ç³»åˆ—ä½œå“åˆ†ç»„
- âœ… ä¼˜å…ˆçº§æ’åº
- âœ… ä¿¡æ¯å®Œæ•´æ€§è¯„åˆ†

---

#### `SeriesDetector` (80è¡Œ)
**å•ä¸€èŒè´£**: æ£€æµ‹å’Œåˆ†ç±»ç³»åˆ—ä½œå“

```dart
class SeriesDetector {
  Map<String, String> extractSeriesInfo(String title);
  int getPriority(String title);
}
```

**èŒè´£**:
- âœ… æ£€æµ‹å­£åº¦ä¿¡æ¯
- âœ… æ£€æµ‹ç‰¹æ®Šç‰ˆæœ¬ï¼ˆå‰§åœºç‰ˆã€OVAï¼‰
- âœ… è®¡ç®—ä¼˜å…ˆçº§

---

### 4. é…ç½® & æ—¥å¿—å±‚

#### `SearchConfig` (60è¡Œ)
**å•ä¸€èŒè´£**: å¯é…ç½®åŒ–çš„è§„åˆ™å’Œé»‘åå•

```dart
class SearchConfig {
  static const nodeClassBlacklist = [...];
  static const garbageKeywords = [...];
  static const titleBlacklist = [...];
  static const seasonPatterns = [...];
  // ... æ›´å¤šé…ç½®
}
```

**ä¼˜åŠ¿**:
- âœ… é›†ä¸­ç®¡ç†é…ç½®
- âœ… æ˜“äºä¿®æ”¹å’Œæ‰©å±•
- âœ… æ— éœ€æ”¹åŠ¨ä¸šåŠ¡ä»£ç 

---

#### `SearchLogger` (30è¡Œ)
**å•ä¸€èŒè´£**: ç»Ÿä¸€çš„æ—¥å¿—æ¥å£

```dart
class SearchLogger {
  void info(String message);
  void success(String message);
  void warning(String message);
  void error(String message);
  void debug(String message);
  void filter(String message);
}
```

**ä¼˜åŠ¿**:
- âœ… å¯å¼€å…³æ—¥å¿—
- âœ… å¯æ§åˆ¶è¯¦ç»†ç¨‹åº¦
- âœ… ç»Ÿä¸€æ—¥å¿—æ ¼å¼

---

## ğŸ“Š ä»£ç é‡å¯¹æ¯”

| æ¨¡å— | åŸæ¶æ„ | æ–°æ¶æ„ | å‡å°‘ |
|------|--------|--------|------|
| **æ ¸å¿ƒæœåŠ¡** | 1000+ è¡Œ | 50 è¡Œ | **-95%** |
| **HTTP è¯·æ±‚** | æ··åœ¨ä¸€èµ· | 30 è¡Œ | ç‹¬ç«‹ |
| **èŠ‚ç‚¹é€‰æ‹©** | 300+ è¡Œ | 50 è¡Œ | **-83%** |
| **èŠ‚ç‚¹è¿‡æ»¤** | æ··åœ¨ä¸€èµ· | 80 è¡Œ | ç‹¬ç«‹ |
| **æ ‡é¢˜æå–** | 200+ è¡Œ | 80 è¡Œ | **-60%** |
| **æ ‡é¢˜éªŒè¯** | æ··åœ¨ä¸€èµ· | 60 è¡Œ | ç‹¬ç«‹ |
| **æ ‡é¢˜å½’ä¸€åŒ–** | æ··åœ¨ä¸€èµ· | 30 è¡Œ | ç‹¬ç«‹ |
| **ç»“æœå»é‡** | 150+ è¡Œ | 70 è¡Œ | **-53%** |
| **ç³»åˆ—æ£€æµ‹** | æ··åœ¨ä¸€èµ· | 80 è¡Œ | ç‹¬ç«‹ |
| **é…ç½®ç®¡ç†** | ç¡¬ç¼–ç  | 60 è¡Œ | ç‹¬ç«‹ |
| **æ—¥å¿—ç®¡ç†** | ç¡¬ç¼–ç  | 30 è¡Œ | ç‹¬ç«‹ |
| **æ€»è®¡** | ~1500 è¡Œ | ~620 è¡Œ | **-59%** |

---

## ğŸ¯ è®¾è®¡åŸåˆ™

### 1. å•ä¸€èŒè´£åŸåˆ™ (SRP)
æ¯ä¸ªç±»åªåšä¸€ä»¶äº‹ï¼ŒèŒè´£æ¸…æ™°ï¼š
- âœ… `HtmlFetcher` åªè´Ÿè´£ HTTP è¯·æ±‚
- âœ… `NodeFilter` åªè´Ÿè´£èŠ‚ç‚¹è¿‡æ»¤
- âœ… `TitleValidator` åªè´Ÿè´£æ ‡é¢˜éªŒè¯

### 2. å¼€é—­åŸåˆ™ (OCP)
å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼š
- âœ… æ–°å¢è¿‡æ»¤è§„åˆ™ï¼šä¿®æ”¹ `SearchConfig`
- âœ… æ–°å¢æå–ç­–ç•¥ï¼šæ‰©å±• `TitleExtractor`
- âœ… æ–°å¢éªŒè¯è§„åˆ™ï¼šæ‰©å±• `TitleValidator`

### 3. ä¾èµ–å€’ç½®åŸåˆ™ (DIP)
ä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°ï¼š
- âœ… æ‰€æœ‰æ¨¡å—é€šè¿‡æ¥å£äº¤äº’
- âœ… æ˜“äºæµ‹è¯•å’Œ Mock

### 4. æ¥å£éš”ç¦»åŸåˆ™ (ISP)
æ¥å£æœ€å°åŒ–ï¼ŒèŒè´£å•ä¸€ï¼š
- âœ… æ¯ä¸ªç±»åªæš´éœ²å¿…è¦çš„æ–¹æ³•
- âœ… é¿å…è‡ƒè‚¿çš„æ¥å£

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ç”¨æ³•
```dart
// åˆ›å»ºæœåŠ¡ï¼ˆé»˜è®¤å¯ç”¨æ—¥å¿—ï¼‰
final searchService = AnimeSearchServiceV2();

// æœç´¢
final results = await searchService.searchAnimes(keyword, rules);
```

### è‡ªå®šä¹‰é…ç½®
```dart
// ç¦ç”¨æ—¥å¿—
final searchService = AnimeSearchServiceV2(
  enableLogging: false,
);

// å¯ç”¨è¯¦ç»†æ—¥å¿—
final searchService = AnimeSearchServiceV2(
  enableLogging: true,
  verboseLogging: true,
);
```

### ä¿®æ”¹é…ç½®
```dart
// åœ¨ SearchConfig ä¸­æ·»åŠ è‡ªå®šä¹‰é»‘åå•
class SearchConfig {
  static const titleBlacklist = [
    ...é»˜è®¤é»‘åå•,
    'ä½ çš„è‡ªå®šä¹‰å…³é”®è¯',
  ];
}
```

---

## ğŸ§ª æµ‹è¯•å‹å¥½

### å•å…ƒæµ‹è¯•
æ¯ä¸ªæ¨¡å—éƒ½å¯ä»¥ç‹¬ç«‹æµ‹è¯•ï¼š

```dart
test('æ ‡é¢˜éªŒè¯å™¨åº”è¯¥æ‹’ç»åƒåœ¾æ ‡é¢˜', () {
  final validator = TitleValidator(logger: SearchLogger(enabled: false));
  
  expect(validator.isValid('APPä¸‹è½½'), false);
  expect(validator.isValid('å‘½è¿çŸ³ä¹‹é—¨'), true);
});

test('èŠ‚ç‚¹è¿‡æ»¤å™¨åº”è¯¥è¿‡æ»¤å¹¿å‘ŠèŠ‚ç‚¹', () {
  final filter = NodeFilter(logger: SearchLogger(enabled: false));
  
  final node = createMockNode(className: 'ad-banner');
  final filtered = filter.filterAnimeCards([node]);
  
  expect(filtered, isEmpty);
});
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. å‡å°‘ä¸å¿…è¦çš„è®¡ç®—
- âœ… æå‰è¿‡æ»¤æ— æ•ˆèŠ‚ç‚¹
- âœ… é¿å…é‡å¤å½’ä¸€åŒ–

### 2. ç¼“å­˜ä¼˜åŒ–
- âœ… å½’ä¸€åŒ–ç»“æœå¯ç¼“å­˜
- âœ… ç³»åˆ—ä¿¡æ¯å¯ç¼“å­˜

### 3. å¹¶å‘å¤„ç†
- âœ… å¤šä¸ªè§„åˆ™å¯å¹¶å‘æœç´¢
- âœ… èŠ‚ç‚¹æå–å¯å¹¶å‘å¤„ç†

---

## ğŸ”„ è¿ç§»æŒ‡å—

### ä»æ—§ç‰ˆæœ¬è¿ç§»

#### 1. æ›¿æ¢å¯¼å…¥
```dart
// æ—§ç‰ˆæœ¬
import '../services/anime_search_service.dart';

// æ–°ç‰ˆæœ¬
import '../services/search/anime_search_service_v2.dart';
```

#### 2. æ›¿æ¢å®ä¾‹åŒ–
```dart
// æ—§ç‰ˆæœ¬
final searchService = AnimeSearchService();

// æ–°ç‰ˆæœ¬
final searchService = AnimeSearchServiceV2();
```

#### 3. API ä¿æŒä¸å˜
```dart
// è°ƒç”¨æ–¹å¼å®Œå…¨ç›¸åŒ
final results = await searchService.searchAnimes(keyword, rules);
```

---

## ğŸ‰ æ€»ç»“

### æ”¹è¿›æ•ˆæœ
1. âœ… ä»£ç é‡å‡å°‘ 59%
2. âœ… èŒè´£æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
3. âœ… é…ç½®åŒ–ï¼Œæ˜“äºæ‰©å±•
4. âœ… æµ‹è¯•å‹å¥½
5. âœ… æ€§èƒ½ä¼˜åŒ–

### æ ¸å¿ƒä¼˜åŠ¿
- **å¯è¯»æ€§**: æ¯ä¸ªç±» < 100 è¡Œï¼ŒèŒè´£å•ä¸€
- **å¯ç»´æŠ¤æ€§**: ä¿®æ”¹ä¸€å¤„ä¸å½±å“å…¶ä»–æ¨¡å—
- **å¯æ‰©å±•æ€§**: æ–°å¢åŠŸèƒ½åªéœ€æ‰©å±•å¯¹åº”æ¨¡å—
- **å¯æµ‹è¯•æ€§**: æ¯ä¸ªæ¨¡å—éƒ½å¯ç‹¬ç«‹æµ‹è¯•

---

**æœ€åæ›´æ–°**: 2026-01-31  
**ç‰ˆæœ¬**: 2.0.0
